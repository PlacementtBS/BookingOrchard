<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Users</title>
<link rel="stylesheet" href="../styles.css" />
<link rel="stylesheet" href="../components.css" />
<link rel="icon" type="image/svg+xml" href="https://jkvthdkqqckhipdlnpuk.supabase.co/storage/v1/object/public/public1//Fill%20Green.svg">

<script src="../utils/nav.js" type="module"></script>
</head>

<body>

<!-- Popup: Add Room Group -->
<div class="popup" id="popup-room-group">
  <form id="form-room-group" onsubmit="return false;">
    <h3>Add Room Group</h3>
    <input type="text" placeholder="Group name" id="input-room-group-name" autocomplete="off" />
    <div class="buttons">
      <button class="primaryButton" type="button" id="btn-save-room-group">Save</button>
      <button type="button" id="btn-cancel-room-group">Cancel</button>
    </div>
  </form>
</div>

<!-- Popup: Add Department -->
<div class="popup" id="popup-department">
  <form id="form-department" onsubmit="return false;">
    <h3>Add Department</h3>
    <input type="text" placeholder="Department name" id="input-department-name" autocomplete="off" />
    <div class="buttons">
      <button class="primaryButton" type="button" id="btn-save-department">Save</button>
      <button type="button" id="btn-cancel-department">Cancel</button>
    </div>
  </form>
</div>

<!-- Navigation -->


<!-- Main content -->
<main class="main">
  <section>
    <div>
      <button id="btn-view-rooms">View Bookable Spaces</button>
    </div>
  </section>

  <div id="content-main">
    <!-- Table & page content renders here -->
  </div>
</main>

<script type="module">
// Import helper functions
import { checkSession, logout } from '../utils/auth.js';
import { renderTablePage } from '../utils/interacttable.js';
import { select, insert } from '../utils/db.js';

// Logout button
document.getElementById('btn-logout').addEventListener('click', () => logout());

document.addEventListener('DOMContentLoaded', async () => {
  const user = await checkSession();
  console.log('Logged in as:', user);

  if (user.product === 'admin') {
    window.location.href = '../admin';
    return;
  }

  const columns = [
    'room',
    'capacity',
    'oRGroup',
    'oDep',
    'cost',
    'costBillingFrequency'
  ];

  const popupRoomGroup = document.getElementById('popup-room-group');
  const popupDepartment = document.getElementById('popup-department');
  const inputRoomGroupName = document.getElementById('input-room-group-name');
  const inputDepartmentName = document.getElementById('input-department-name');

  /**
   * Load data and render the room table
   */
  async function loadAndRenderTable() {
    // Get rooms
    const rooms = await select('rooms', '*', {
      column: 'oId',
      operator: 'eq',
      value: user.organisationId
    });

    const data = rooms.map(row => ({
      id: row.id,
      values: columns.map(col => row[col] ?? '')
    }));

    // Get department and room group options
    const departments = await select('orgDepartments', '*', {
      column: 'oId',
      operator: 'eq',
      value: user.organisationId
    });
    const roomGroups = await select('orgRoomGroups', '*', {
      column: 'oId',
      operator: 'eq',
      value: user.organisationId
    });

    const departmentOptions = departments.map(d => ({ value: d.id, label: d.departmentName }));
    const roomGroupOptions = roomGroups.map(r => ({ value: r.id, label: r.groupName }));

    renderTablePage('content-main', {
      columns,
      friendlyNames: ['Room', 'Capacity', 'Group', 'Department', 'Cost', 'Billing Frequency'],
      data,
      tableName: 'rooms',
      dropdowns: {
        oDep: {
          options: departmentOptions,
          formId: 'popup-department'
        },
        oRGroup: {
          options: roomGroupOptions,
          formId: 'popup-room-group'
        },
        costBillingFrequency: {
          options: [
            { value: 'Hourly', label: 'Hourly' },
            { value: 'Daily', label: 'Daily' },
            { value: 'Weekly', label: 'Weekly' }
          ]
        }
      },
      extraInsertFields: { oId: user.organisationId }
    });
  }

  await loadAndRenderTable();

  // Utility to close popup
  function closePopup(popupElement, inputElement) {
    popupElement.style.display = 'none';
    inputElement.value = '';
  }

  // Click outside popup to close
  popupRoomGroup.addEventListener('click', e => {
    if (e.target === popupRoomGroup) closePopup(popupRoomGroup, inputRoomGroupName);
  });
  popupDepartment.addEventListener('click', e => {
    if (e.target === popupDepartment) closePopup(popupDepartment, inputDepartmentName);
  });

  // Cancel buttons
  document.getElementById('btn-cancel-room-group').addEventListener('click', () => {
    closePopup(popupRoomGroup, inputRoomGroupName);
  });
  document.getElementById('btn-cancel-department').addEventListener('click', () => {
    closePopup(popupDepartment, inputDepartmentName);
  });

  // Save room group
  document.getElementById('btn-save-room-group').addEventListener('click', async () => {
    const groupName = inputRoomGroupName.value.trim();
    if (!groupName) return alert('Enter a group name.');

    try {
      await insert('orgRoomGroups', { groupName, oId: user.organisationId });
      alert('Room group saved.');
      closePopup(popupRoomGroup, inputRoomGroupName);
      await loadAndRenderTable();
    } catch (error) {
      console.error('Failed to save room group:', error);
    }
  });

  // Save department
  document.getElementById('btn-save-department').addEventListener('click', async () => {
    const departmentName = inputDepartmentName.value.trim();
    if (!departmentName) return alert('Enter a department name.');

    try {
      await insert('orgDepartments', { departmentName, oId: user.organisationId });
      alert('Department saved.');
      closePopup(popupDepartment, inputDepartmentName);
      await loadAndRenderTable();
    } catch (error) {
      console.error('Failed to save department:', error);
    }
  });
});
</script>

</body>
</html>
